<html>
    
<head>
    <style>
        .trip {
            margin-left: 50px;
        }

        #popup {
            padding: 30px;
            position: absolute;
            left: 400px;
            top: 400px;
            z-index: 10;
            background-color: lightblue;
            border: 1px;
            border-style: solid;
        }

        .map {
            position: absolute;
            cursor: crosshair;
            left: 100px;
        }

        .indent {
            margin-bottom: 20px;
        }

        #trips {
            position: absolute;
            left: 1150px;
        }

        #search-strategy {
            width: 100px;
        }
    </style>
    <meta charset="UTF-8">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/WSApi.js"></script>
</head>

<body>
    <div id="popup">
        <h2>Your trip is scheduled!</h2>
    </div>
    <div>
        <h1>Request a Trip:</h1>
    </div>
    <div class="indent">Name: <input id="name" type="Text"></div>
    <div class="indent">Search Strategy:
        <select id="search-strategy">
            <option value="astar">Astar</option>
            <option value="dfs">DFS</option>
            <option value="dijkstra">Dijkstra</option>
        </select>
    </div>
    <div class="indent" style="width: 1000px; height: 650px;">Select Start / Destination:
        <br><br>
        <div><img src="assets/texture/umn.png" width="1000" height="600" class="map">
            <svg id="map" width="1000" height="600" class="map">
            </svg>
        </div>

        <div id="trips">
            <div id="list" style="width: 400px">
                <p style="font-weight: bold;">Trips:</p>
            </div>
        </div>
    </div>
    <div><input type="button" value="Schedule Trip" onclick="schedule()"></div>
    <br>
    <!-------- Modification for CSCI 3081 HW4 Spring 2023 -------->
    <!-------- form for experiment -------->
    <div class="experiment-form">
        <form style="box-sizing: border-box; border: 2px solid black;">
            <h2>Start Experiment</h2>
            <p>By selecting the number of drones and robots it will automatically start the simulation</p>
            <label>Select the number of Drones: </label>
            <input type="number" id="num-drones" value="Number of drones" placeholder="1" min="1", max="10" required>
            <br>
            <label>Select the number of Robots: </label>
            <input type="number" id="num-robots" value="Number of robots" placeholder="1" min="1", max="10" style="margin-top: 10px;" required>
            <br>
            <div class="indent">Search Strategy:
                <select id="search-strategy-experiment" required>
                    <option value="" selected disabled value>Select a search strategy</option>
                    <option value="astar">Astar</option>
                    <option value="dfs">DFS</option>
                    <option value="dijkstra">Dijkstra</option>
                </select>
            </div>
            <input type="button" value="Click to Start Experiment" onclick="startExperiment()" style="margin-top: 10px;">
            <div class="indent">
                File Name: 
                <input id="fileName" type="Text" style="margin-top:10px;margin-bottom:5px;" required>
                <input type="button" value="Export Data to CSV" onclick="exportData()" style="margin-top: 5px;">
            </div>
            <p id="sucess-export"></p>
            
        </form>
    </div>
    <div>
        <input type="button" value="Add Human" onclick="addHuman()" style="margin-top: 10px;">
    </div>
    

    <div id="nameError"></div>

    <script>
        // Web Sockets API for communication with the backend
        let api = new WSApi();

        var trip = [];

        var helicopterID = 1;

        // This method is called when the document is loaded
        $(document).ready(function () {
            // hide the popup
            $("#popup").hide();

            // register a mouse click event that adds circles on an image
            $('#map').click(function (e) {
                if (trip.length < 2) {
                    var posX = e.pageX - $(this).offset().left;
                    var posY = e.pageY - $(this).offset().top;
                    console.log("x: " + posX + " y: " + posY + "")
                    $("#map").append('<circle cx="' + posX + '" cy="' + posY + '" r="10" stroke="green" stroke-width="4" fill="yellow" />');
                    $("#map").html($("#map").html());
                    trip.push([posX, posY]);
                } else {
                    $("#map").empty();
                    $("#map").append('<circle cx="' + trip[0][0] + '" cy="' + trip[0][1] + '" r="10" stroke="green" stroke-width="4" fill="yellow" />');
                    var posX = e.pageX - $(this).offset().left;
                    var posY = e.pageY - $(this).offset().top;
                    $("#map").append('<circle cx="' + posX + '" cy="' + posY + '" r="10" stroke="green" stroke-width="4" fill="blue" />');
                    $("#map").html($("#map").html());
                    trip.insert(1, [[posX, posY]]);
                }
            });
        });

        // Web sockets event callback
        api.onmessage = function (msg, data) {
            // handles events
            if ("event" in data) {
                console.log(data);
                if (data.event == "TripScheduled") {
                    $("#popup").show();
                    $("#popup").fadeOut(3000);
                }
            }
        }

        // This function schedules a trip and sends the command to the web sockets api.
        function schedule() {
            var errorDiv = document.getElementById("nameError");
            var searchStrat = document.getElementById("search-strategy").value;
            //var searchStrat = "beeline";
            errorDiv.innerHTML = "";
            var name = $("#name").val();
            if (name == "") {
                errorDiv.innerHTML += '<p style="color: red">[!] Error, missing name...</p>'
            }
            if (trip.length < 2) {
                errorDiv.innerHTML += '<p style="color: red">[!] Error, missing pickup and drop off location ...</p>'
            }
            if (name != "" && trip.length >= 2) {
                var start = [trip[0][0] / ($("#map").width()), 1.0, trip[0][1] / ($("#map").height())];
                var end = [trip[trip.length - 1][0] / ($("#map").width()), 1.0, trip[trip.length - 1][1] / ($("#map").height())];
                console.log(start);
                var scale = 0.705;
                var min = { x: -2030.950927734375, y: 220.99996948242188, z: -1184.1085205078125 };
                var max = { x: 2249.523193359375, y: 286.9197998046875, z: 1261.8768310546875 };

                api.sendCommand("CreateEntity", {
                    "type": "robot",
                    "name": name,
                    "mesh": "assets/model/robot.glb",
                    "position": [(min.x + (max.x - min.x) * start[0]) * scale, 254.665 * start[1], (min.z + (max.z - min.z) * start[2]) * scale],
                    "scale": [0.25, 0.25, 0.25],
                    "direction": [1, 0, 0],
                    "speed": 30.0,
                    "radius": 1.0,
                    "rotation": [0, 0, 0, 0]
                });
                api.sendCommand("ScheduleTrip", { name: name, start: [trip[0][0], trip[0][1]], end: [(min.x + (max.x - min.x) * end[0]) * scale, 254.665 * end[1], (min.z + (max.z - min.z) * end[2]) * scale], search: searchStrat });
                var details = name + ": ";
                for (var i = 0; i < trip.length; i++) {
                    if (i != 0) {
                        details += " ---> ";
                    }
                    details += "(" + trip[i][0].toFixed(1) + ", " + trip[i][1].toFixed(1) + ")";

                }
                $("#list").append("<p class='trip'>" + details + "</p>");

                // reset the trip
                trip = [];
                $("#map").html("");
                $("#name").val("");
            }
        }
        var humanID = 1;
        function addHuman() {
            api.sendCommand("CreateEntity", {
                "type": "human",
                "name": "Human-" + humanID,
                "mesh": "assets/model/human.glb",
                "position": [700, 290, 400],
                "scale": [0.005, 0.005, 0.005],
                "rotation": [0, 0, 0, 0],
                "direction": [1, 0, 0],
                "speed": 10.0,
                "radius": 1.0,
                "start": 2.0,
                "duration": 2.0,
                "offset": [0, -0.5, 0]
            });
            humanID += 1;
        }

        // ----------------------------------------------------------------
        // Modification for CSCI 3081 HW4 Spring 2023
        // Export data to CSV file
        

        function exportData() {
            var fileName = $("#fileName").val();
            if (fileName.endsWith(".csv") == false) {
                alert("Your file must end with: .csv"); 
                return;
            }
            if (fileName == "") {
                errorDiv.innerHTML += '<p style="color: red">[!] Error, missing file name...</p>'
            }
            api.sendCommand("ExportCSV",{"name": fileName});
            let success = document.getElementById("sucess-export");
            success.innerHTML = "Sucesss!!! Successfully exported data to " + fileName;
            setTimeout(() => {
                success.innerHTML = "";
            }, 8000); 
        }

        // This is a function for creating drones and robots automatically 
        function startExperiment() {
            // return a random number between min and max
            let getRandomArbitrary = (min, max) => {
                return Math.random() * (max - min) + min;
            }
            numdrones = document.getElementById("num-drones").value;
            numrobots = document.getElementById("num-robots").value;
            let searchStrat = document.getElementById("search-strategy-experiment").value;
            console.log(numdrones); 
            console.log(numrobots);
            console.log(searchStrat);
            if (numdrones == "" || numdrones == "" || searchStrat == "") {
                console.log("You are missing required fields!"); 
                alert("Please select all the required fields to start the experiment!"); 
                return;
            }
            let trip = []
            console.log(trip);
            let scale = 0.705;
            let min = { x: -2030.950927734375, y: 220.99996948242188, z: -1184.1085205078125 };
            var max = { x: 2249.523193359375, y: 286.9197998046875, z: 1261.8768310546875 };
            if (numdrones > 0 && numrobots > 0 && searchStrat != "") {
                // creat robots
                for (let i = 0; i < numrobots; i++) {
                    for (let i = 0; i < 2; i++) {
                        let posX = getRandomArbitrary(0, 1000);
                        let posY = getRandomArbitrary(0, 600);
                        trip.push([posX, posY]);
                    }
                    let start = [trip[0][0] / ($("#map").width()), 1.0, trip[0][1] / ($("#map").height())];
                    let end = [trip[trip.length - 1][0] / ($("#map").width()), 1.0, trip[trip.length - 1][1] / ($("#map").height())];
                    console.log(start);
                    api.sendCommand("CreateEntity", {
                        "type": "robot",
                        "name": "Robot-" + i,
                        "mesh": "assets/model/robot.glb",
                        "position": [(min.x + (max.x - min.x) * start[0]) * scale, 254.665 * start[1], (min.z + (max.z - min.z) * start[2]) * scale],
                        "scale": [0.25, 0.25, 0.25],
                        "direction": [1, 0, 0],
                        "speed": 30.0,
                        "radius": 1.0,
                        "rotation": [0, 0, 0, 0]
                    });
                    api.sendCommand("ScheduleTrip", { name: "Robot-" + i, start: [trip[0][0], trip[0][1]], end: [(min.x + (max.x - min.x) * end[0]) * scale, 254.665 * end[1], (min.z + (max.z - min.z) * end[2]) * scale], search: searchStrat });
                    trip = [] 
                }
                // Create drones
                let addDrones = (droneID) => { 
                    api.sendCommand("CreateEntity", {
                        "type": "drone",
                        "name": "Drone-" + droneID,
                        "mesh": "assets/model/drone.glb",
                        "position": [498.292, 270, -228.623],
                        "scale": [0.1, 0.1, 0.1],
                        "rotation": [0, 0, 0, 0],
                        "direction": [1, 0, 0],
                        "speed": 30.0,
                        "radius": 1.0,
                        "start": 2.0,
                        "duration": 2.0,
                        "offset": [0, 0.6, 0]
                    })
                }
                for (let i = 1; i < numdrones; i++) {
                    addDrones(i);
                }
                let details = name + ": ";
                for (let i = 0; i < trip.length; i++) {
                    if (i != 0) {
                        details += " ---> ";
                    }
                    details += "(" + trip[i][0].toFixed(1) + ", " + trip[i][1].toFixed(1) + ")";
                }
                $("#list").append("<p class='trip'>" + details + "</p>");
            }
        }
    </script>
</body>

</html>